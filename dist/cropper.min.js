angular.module("bg.imageCropper",[]),angular.module("bg.imageCropper").directive("bgImageCropper",["$document",function(a){function b(b,c,d){var e,f,g,h,i,j,k,l,m,n,o,p,q=c[0],r=a[0],s=q.querySelector("canvas"),t=s.getContext("2d"),u=new FileReader,v=q.querySelector('input[type="file"]'),w=q.querySelector(".bgic-source"),x=w.querySelector(".bgic-selection"),y=w.querySelector("img"),z=!1,A=!1,B=b.previewWidth,C=[];x.addEventListener("mousedown",function(a){if(g=x.getBoundingClientRect(),h=g.top,i=g.left,n=a.clientX,o=a.clientY,a.target.classList.contains("bgic-handle"))switch(A=!0,k=g.bottom-g.top,j=g.right-g.left,m=a.target.dataset.resizeDir){case"nw":l=Math.min(g.bottom-f.top+window.scrollY,g.right-f.left+window.scrollX),x.style.bottom=f.bottom-g.bottom-window.scrollY+"px",x.style.right=f.right-g.right-window.scrollX+"px",x.style.top=null,x.style.left=null,b.sourceState="resizing-nwse";break;case"ne":l=Math.min(g.bottom-f.top+window.scrollY,f.right-g.left-window.scrollX),x.style.bottom=f.bottom-g.bottom-window.scrollY+"px",x.style.left=window.scrollX+g.left-f.left+"px",x.style.top=null,x.style.right=null,b.sourceState="resizing-nesw";break;case"se":l=Math.min(f.bottom-g.top-window.scrollY,f.right-g.left-window.scrollX),x.style.top=window.scrollY+g.top-f.top+"px",x.style.left=window.scrollX+g.left-f.left+"px",x.style.bottom=null,x.style.right=null,b.sourceState="resizing-nwse";break;case"sw":l=Math.min(f.bottom-g.top-window.scrollY,g.right-f.left+window.scrollX),x.style.top=window.scrollY+g.top-f.top+"px",x.style.right=f.right-g.right-window.scrollX+"px",x.style.bottom=null,x.style.left=null,b.sourceState="resizing-nesw"}else x.style.top=window.scrollY+g.top-f.top+"px",x.style.left=window.scrollX+g.left-f.left+"px",x.style.bottom=null,x.style.right=null,e={right:f.width-g.height,bottom:f.height-g.height},z=!0,b.sourceState="moving";b.$apply()},!0),r.addEventListener("mousemove",function(a){var c,d;if(z){var q=a.clientX-n,r=a.clientY-o;c=Math.min(e.right,Math.max(0,i+q+window.scrollX-f.left)),d=Math.min(e.bottom,Math.max(0,h+r+window.scrollY-f.top)),x.style.top=d+"px",x.style.left=c+"px"}else if(A){var s,u,v=a.clientX-n,w=a.clientY-o;switch(m){case"nw":s=j-v,u=k-w;break;case"ne":s=j+v,u=k-w;break;case"se":s=j+v,u=k+w;break;case"sw":s=j-v,u=k+w}B=Math.min(l,Math.max(s,u)),x.style.width=B+"px",x.style.height=B+"px",g=x.getBoundingClientRect(),c=window.scrollX+g.left-f.left,d=window.scrollY+g.top-f.top}(z||A)&&(t.clearRect(0,0,b.previewHeight,b.previewWidth),t.drawImage(y,c/p,d/p,B/p,B/p,0,0,b.previewHeight,b.previewWidth))},!0),r.addEventListener("mouseup",function(a){z=!1,A=!1,b.sourceState="",b.$apply()},!0),y.addEventListener("load",function(){t.clearRect(0,0,s.width,s.height),t.drawImage(y,0,0,y.width,y.height,0,0,y.width,y.height),f=w.getBoundingClientRect(),p=y.height/y.naturalHeight,B=b.previewWidth*p,x.style.top="0",x.style.left="0",x.style.bottom=null,x.style.right=null,x.style.width=B+"px",x.style.height=B+"px",g=x.getBoundingClientRect()},!0),u.addEventListener("load",function(a){b.src=a.target.result,b.$apply()},!0),v.addEventListener("change",function(a){var c=a.target.files[0];c&&(b.filename=c.name,u.readAsDataURL(c),b.$apply())},!0),w.addEventListener("dragover",function(a){a.preventDefault()},!0),w.addEventListener("drop",function(a){a.preventDefault();var c=a.dataTransfer.files[0];c&&(b.filename=c.name,u.readAsDataURL(c),b.$apply())},!0),b.savePic=function(a){s.toBlob(function(c){var e={contents:c,filename:b.filename};b.pic=e,angular.isDefined(a)&&d.$emit("bgic.captured",a,e)})},C.push(d.$on("bgic.clear",function(){delete b.src,delete b.filename,t.clearRect(0,0,b.previewHeight,b.previewWidth)})),C.push(d.$on("bgic.load",function(a,c){b.src=c})),C.push(d.$on("bgic.choose",function(){var a=r.createEvent("MouseEvents");a.initMouseEvent("click"),v.dispatchEvent(a)})),C.push(d.$on("bgic.capture",function(a,c){b.savePic(c)})),b.$on("$destroy",function(){C.forEach(function(a){a()})})}return{scope:{previewWidth:"@bgicPreviewWidth",previewHeight:"@bgicPreviewHeight",src:"@bgicDefaultSrc",previewRounded:"@bgicPreviewRounded",pic:"=ngModel"},restrict:"E",templateUrl:"/templates/cropper.html",controller:["$scope","$element","$rootScope",b]}}]),angular.module("bg.imageCropper").factory("bgImageCropper",["$rootScope","$q",function(a,b){function c(b){a.$emit("bgic.load",b)}function d(){a.$emit("bgic.choose")}function e(){a.$emit("bgic.clear")}function f(){var c=h++,d=b.defer();return g[c]=d,a.$emit("bgic.capture",c),d.promise}var g={},h=0;return a.$on("bgic.captured",function(a,b,c){g[b]&&(g[b].resolve(c),delete g[b])}),{loadImage:c,clearImage:e,chooseImage:d,captureSelection:f}}]),angular.module("bg.imageCropper").run(["$templateCache",function(a){"use strict";a.put("/templates/cropper.html",'<div class="bgic-source" ng-class="[sourceState, {\'bgic-no-image\': !src}]"><div class="bgic-selection"><div class="bgic-bar bgic-bar-top"></div><div class="bgic-bar bgic-bar-bottom"></div><div class="bgic-bar bgic-bar-left"></div><div class="bgic-bar bgic-bar-right"></div><div data-resize-dir="ne" class="bgic-handle bgic-handle-tr"></div><div data-resize-dir="nw" class="bgic-handle bgic-handle-tl"></div><div data-resize-dir="se" class="bgic-handle bgic-handle-br"></div><div data-resize-dir="sw" class="bgic-handle bgic-handle-bl"></div></div><img ng-src="{{src}}"></div><canvas class="bgic-preview" ng-class="{rounded: previewRounded}" width="{{previewWidth}}" height="{{previewHeight}}"></canvas><input class="bgic-picker" type="file"><div class="bgic-filename">{{filename}}</div><button class="bgic-apply" ng-click="savePic()">Clip It!</button>')}]);